name: Health Check and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '*/15 * * * *'  # 15åˆ†æ¯ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
  workflow_dispatch:

# GitHub Pagesç”¨ã®æ¨©é™è¨­å®š
permissions:
  contents: read
  pages: write
  id-token: write

# åŒæ™‚å®Ÿè¡Œã®åˆ¶å¾¡
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate JSON configuration files
        run: |
          echo "Validating configuration files..."
          
          # wiki-sources.json ã®æ¤œè¨¼
          if [ -f "config/wiki-sources.json" ]; then
            echo "Validating wiki-sources.json..."
            jq empty config/wiki-sources.json || exit 1
            echo "âœ“ wiki-sources.json is valid"
          else
            echo "âš  wiki-sources.json not found"
          fi
          
          # environments.json ã®æ¤œè¨¼
          if [ -f "config/environments.json" ]; then
            echo "Validating environments.json..."
            jq empty config/environments.json || exit 1
            echo "âœ“ environments.json is valid"
          else
            echo "âš  environments.json not found"
          fi
          
          # wiki-cache.json ã®æ¤œè¨¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f "data/wiki-cache.json" ]; then
            echo "Validating wiki-cache.json..."
            jq empty data/wiki-cache.json || exit 1
            echo "âœ“ wiki-cache.json is valid"
          else
            echo "â„¹ wiki-cache.json not found (will be created by wiki fetch)"
          fi

      - name: Test JavaScript syntax
        run: |
          echo "Testing JavaScript files..."
          
          for js_file in js/*.js scripts/*.js; do
            if [ -f "$js_file" ]; then
              echo "Checking $js_file..."
              node -c "$js_file" || exit 1
              echo "âœ“ $js_file syntax is valid"
            fi
          done

      - name: Validate HTML structure
        run: |
          echo "Validating HTML structure..."
          
          if [ -f "index.html" ]; then
            # åŸºæœ¬çš„ãªHTMLæ§‹é€ ãƒã‚§ãƒƒã‚¯
            grep -q "<!DOCTYPE html>" index.html || (echo "âœ— Missing DOCTYPE" && exit 1)
            grep -q "<html" index.html || (echo "âœ— Missing html tag" && exit 1)
            grep -q "<head>" index.html || (echo "âœ— Missing head tag" && exit 1)
            grep -q "<body>" index.html || (echo "âœ— Missing body tag" && exit 1)
            echo "âœ“ HTML structure is valid"
          else
            echo "âœ— index.html not found"
            exit 1
          fi

      - name: Check CSS files
        run: |
          echo "Checking CSS files..."
          
          for css_file in css/*.css; do
            if [ -f "$css_file" ]; then
              echo "Checking $css_file..."
              # åŸºæœ¬çš„ãªCSSæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆä¸­æ‹¬å¼§ã®ãƒãƒ©ãƒ³ã‚¹ï¼‰
              if [ $(grep -o '{' "$css_file" | wc -l) -eq $(grep -o '}' "$css_file" | wc -l) ]; then
                echo "âœ“ $css_file braces are balanced"
              else
                echo "âœ— $css_file has unbalanced braces"
                exit 1
              fi
            fi
          done

      - name: Test environment data structure
        run: |
          echo "Testing environment data structure..."
          
          if [ -f "data/wiki-cache.json" ]; then
            # å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
            jq -e '.environments' data/wiki-cache.json > /dev/null || (echo "âœ— Missing environments array" && exit 1)
            jq -e '.last_updated' data/wiki-cache.json > /dev/null || (echo "âœ— Missing last_updated field" && exit 1)
            
            # å„ç’°å¢ƒã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºèª
            jq -e '.environments[] | select(.id and .name)' data/wiki-cache.json > /dev/null || (echo "âœ— Some environments missing id or name" && exit 1)
            
            echo "âœ“ Environment data structure is valid"
          else
            echo "â„¹ No wiki-cache.json to validate"
          fi

      - name: Simulate health checks
        run: |
          echo "Simulating health checks..."
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒURLã‚’å–å¾—ã—ã¦ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
          if [ -f "data/wiki-cache.json" ]; then
            echo "Testing configured environments..."
            
            # å…¬é–‹URLã®ã¿ãƒ†ã‚¹ãƒˆï¼ˆlocalhostç­‰ã¯é™¤å¤–ï¼‰
            urls=$(jq -r '.environments[]? | select(.url and (.url | test("^https?://(?!localhost|127\\.0\\.0\\.1|0\\.0\\.0\\.0).*"))) | .url' data/wiki-cache.json 2>/dev/null || echo "")
            
            if [ -n "$urls" ]; then
              echo "Found URLs to test: $(echo "$urls" | wc -l)"
              for url in $urls; do
                echo "Testing $url..."
                # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã¿ãƒã‚§ãƒƒã‚¯
                status=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url" || echo "timeout")
                echo "  Status: $status"
              done
            else
              echo "No public URLs found to test"
            fi
          else
            echo "No environment data available for testing"
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: health-check
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: [health-check, deploy]
    if: always()
    
    steps:
      - name: Health Check Summary
        run: |
          echo "## Health Check Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "âœ… Health checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Health checks failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful" >> $GITHUB_STEP_SUMMARY
            echo "ğŸŒ **Site URL:** https://xtc1988.github.io/env-signage-dashboard/" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "â­ï¸ Deployment skipped (not main branch)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY